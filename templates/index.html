<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker - Auth</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Chart.js for the line plot -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f9;
        }
        .form-input {
            /* Applying Tailwind classes directly */
            @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-150;
        }
    </style>
</head>
<!-- Flask passes the logged_in_user and logged_in_role variables for JS initialization -->
<body class="min-h-screen flex items-center justify-center p-4" 
      data-logged-in-user="{{ logged_in_user if logged_in_user else '' }}"
      data-logged-in-role="{{ logged_in_role if logged_in_role else '' }}">

    <!-- Auth Card Container -->
    <div id="auth-container" class="w-full max-w-md bg-white shadow-2xl rounded-xl p-8 space-y-6">

        <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <h2 id="auth-title" class="mt-3 text-3xl font-extrabold text-gray-900">
                Personal Finance Tracker
            </h2>
        </div>

        <!-- Tab Controls -->
        <div id="auth-tabs" class="flex border-b border-gray-200">
            <button id="tab-login" onclick="showForm('login')" class="flex-1 py-3 text-sm font-medium text-center transition duration-200 border-b-2 border-transparent hover:text-emerald-600" data-active="true">
                Sign In
            </button>
            <button id="tab-register" onclick="showForm('register')" class="flex-1 py-3 text-sm font-medium text-center transition duration-200 border-b-2 border-transparent hover:text-emerald-600" data-active="false">
                Create Account
            </button>
        </div>
        
        <!-- Messages -->
        <div id="message-box" class="hidden p-3 rounded-lg text-sm transition duration-300"></div>

        <!-- Login Form -->
        <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)" style="display: block;">
            <div>
                <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input id="login-username" type="text" required class="form-input" placeholder="Your username">
            </div>
            <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input id="login-password" type="password" required class="form-input" placeholder="Your password">
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150">
                Log In
            </button>
        </form>

        <!-- Registration Form -->
        <form id="register-form" class="space-y-4" onsubmit="handleRegister(event)" style="display: none;">
            <div>
                <label for="reg-username" class="block text-sm font-medium text-gray-700 mb-1">New Username</label>
                <input id="reg-username" type="text" required class="form-input" placeholder="Choose a username">
            </div>
            <div>
                <label for="reg-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                <input id="reg-password" type="password" required class="form-input" placeholder="Create a strong password">
            </div>
            <div>
                <label for="reg-secret" class="block text-sm font-medium text-gray-700 mb-1">Secret Key</label>
                <input id="reg-secret" type="password" required class="form-input" placeholder="Enter registration secret key">
                <p class="mt-1 text-xs text-gray-500">
                    Use the **Admin Key** for full access, or the **Standard Key** for expense-only access.
                </p>
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150">
                Create Account
            </button>
        </form>
        
    </div>

    <!-- Main Application Content (Transaction Tracker) -->
    <div id="app-content" class="hidden w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6">
        
        <!-- App Header -->
        <div class="flex justify-between items-center border-b pb-4">
            <h1 class="text-2xl font-bold text-gray-800">
                Transaction Tracker
            </h1>
            <button onclick="handleLogout()" class="py-1 px-3 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                Logout
            </button>
        </div>

        <p id="welcome-message" class="text-sm text-gray-600 border-b pb-3"></p>
        
        <!-- Transaction Form -->
        <form id="transaction-form" class="space-y-5" onsubmit="handleTransaction(event)">
            <h3 class="text-xl font-semibold text-emerald-800">Record New Entry</h3>

            <!-- Amount Input -->
            <div>
                <label for="trans-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (₹)</label>
                <input id="trans-amount" type="number" step="0.01" min="0.01" required class="form-input text-lg font-mono text-right" placeholder="0.00">
            </div>

            <!-- Type Selector (Income/Expense) - Required for the Transaction record itself -->
            <div class="flex space-x-4">
                <div class="flex-1">
                    <input type="radio" id="type-expense" name="trans-type" value="expense" checked class="hidden peer">
                    <label for="type-expense" class="w-full py-2 px-4 rounded-lg border-2 border-red-400 text-center text-sm font-medium cursor-pointer text-red-600 peer-checked:bg-red-50 peer-checked:border-red-600 transition duration-150">
                        Expense
                    </label>
                </div>
                <div class="flex-1">
                    <input type="radio" id="type-income" name="trans-type" value="income" class="hidden peer">
                    <label for="type-income" class="w-full py-2 px-4 rounded-lg border-2 border-emerald-400 text-center text-sm font-medium cursor-pointer text-emerald-600 peer-checked:bg-emerald-50 peer-checked:border-emerald-600 transition duration-150">
                        Income
                    </label>
                </div>
            </div>

            <!-- Category Selector and Summary Button -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label for="trans-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <div class="flex space-x-2">
                         <!-- Summary Button (Admin only) -->
                        <button id="summary-button" type="button" onclick="handleSummary()" class="hidden py-1 px-3 text-xs font-medium text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                            <svg class="w-4 h-4 inline mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m4 0a2 2 0 002 2h2a2 2 0 002-2m-4 0v-2a2 2 0 012-2h2a2 2 0 012 2v2m-6 0h6"></path></svg>
                            Summary
                        </button>
                        <!-- Download Button (Admin only) -->
                        <button id="download-button" type="button" onclick="downloadCSV()" class="hidden py-1 px-3 text-xs font-medium text-white bg-indigo-500 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                            <svg class="w-4 h-4 inline mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Download Report
                        </button>
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <select id="trans-category" required class="form-input flex-grow">
                        <!-- Categories will be populated here by JavaScript -->
                    </select>
                    <button type="button" onclick="showCategoryModal()" class="flex-shrink-0 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm text-sm">
                        + New
                    </button>
                </div>
            </div>

            <!-- Date Range Filter (Admin only, displayed near the Summary button) -->
            <div id="date-range-inputs" class="space-y-4 border-t pt-4 border-gray-200 hidden">
                <h4 class="text-base font-semibold text-gray-800">Summary Date Range (Admin)</h4>
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label for="start-date" class="block text-xs font-medium text-gray-500 mb-1">Start Date</label>
                        <input id="start-date" type="date" class="form-input text-sm">
                    </div>
                    <div class="flex-1">
                        <label for="end-date" class="block text-xs font-medium text-gray-500 mb-1">End Date</label>
                        <input id="end-date" type="date" class="form-input text-sm">
                    </div>
                </div>
            </div>

            <!-- Note/Description Input -->
            <div>
                <label for="trans-note" class="block text-sm font-medium text-gray-700 mb-1">Note (Optional)</label>
                <textarea id="trans-note" class="form-input resize-none h-20" placeholder="Brief description of the transaction"></textarea>
            </div>

            <button type="submit" class="w-full py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-lg hover:bg-emerald-700 transition duration-200">
                Record Transaction
            </button>
        </form>

        <!-- New Category Modal -->
        <div id="category-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl space-y-4">
                <h4 class="text-xl font-bold text-gray-800">Create New Category</h4>
                
                <form id="new-category-form" onsubmit="handleNewCategory(event)" class="space-y-3">
                    <div>
                        <label for="new-cat-name" class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                        <input id="new-cat-name" type="text" required class="form-input" placeholder="e.g., Coffee, Dividend, Groceries">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="hideCategoryModal()" class="py-2 px-4 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                            Save Category
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- End New Category Modal -->
        
        <!-- Summary Modal (Updated for charts and tables) -->
        <div id="summary-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 w-full max-w-4xl shadow-2xl space-y-6">
                <h4 class="text-3xl font-bold text-gray-800 border-b pb-3">Financial Performance Report</h4>
                
                <!-- Summary Header -->
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <p id="summary-category-display" class="text-lg font-medium text-gray-600"></p>
                    <p id="summary-date-display" class="text-sm font-normal text-gray-500"></p>
                </div>

                <!-- Balance Display -->
                <div class="bg-emerald-50 p-4 rounded-lg shadow-inner">
                    <p class="text-xl font-semibold text-gray-700">Net Balance</p>
                    <p class="text-4xl font-extrabold text-gray-900 mt-1">
                        <span id="summary-balance" class="font-mono"></span>
                    </p>
                </div>
                
                <!-- Chart Section -->
                <div class="w-full bg-gray-50 p-4 rounded-lg shadow-md">
                    <h5 class="text-xl font-semibold mb-3 text-gray-700">Daily Trend: Income vs. Expense</h5>
                    <!-- Chart canvas container -->
                    <div class="relative h-80">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>

                <!-- Top Categories Section -->
                <div class="grid md:grid-cols-2 gap-6 pt-4">
                    
                    <!-- Top Income -->
                    <div class="bg-green-50 p-4 rounded-lg shadow-md">
                        <h5 class="text-xl font-semibold mb-3 text-emerald-800 flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                            Top Income Categories
                        </h5>
                        <ul id="top-income-list" class="space-y-2">
                            <li class="text-gray-500 italic">No income transactions found in this range.</li>
                        </ul>
                    </div>

                    <!-- Top Expense -->
                    <div class="bg-red-50 p-4 rounded-lg shadow-md">
                        <h5 class="text-xl font-semibold mb-3 text-red-800 flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                            Top Expense Categories
                        </h5>
                        <ul id="top-expense-list" class="space-y-2">
                            <li class="text-gray-500 italic">No expense transactions found in this range.</li>
                        </ul>
                    </div>
                </div>

                <div class="flex justify-end pt-4 border-t">
                    <button type="button" onclick="document.getElementById('summary-modal').classList.add('hidden')" class="py-2 px-4 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150">
                        Close Report
                    </button>
                </div>
            </div>
        </div>
        <!-- End Summary Modal -->

    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const appContent = document.getElementById('app-content');
        const messageBox = document.getElementById('message-box');
        const welcomeMessage = document.getElementById('welcome-message');
        const tabs = {
            login: document.getElementById('tab-login'),
            register: document.getElementById('tab-register')
        };
        const transactionForm = document.getElementById('transaction-form');
        const categorySelect = document.getElementById('trans-category');
        const incomeTypeRadio = document.getElementById('type-income');
        const categoryModal = document.getElementById('category-modal');
        const newCategoryForm = document.getElementById('new-category-form');
        
        // Summary Elements
        const summaryButton = document.getElementById('summary-button');
        const downloadButton = document.getElementById('download-button');
        const dateRangeInputs = document.getElementById('date-range-inputs');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const summaryModal = document.getElementById('summary-modal');
        const summaryBalanceDisplay = document.getElementById('summary-balance');
        const summaryCategoryDisplay = document.getElementById('summary-category-display');
        const summaryDateDisplay = document.getElementById('summary-date-display');
        const topIncomeList = document.getElementById('top-income-list');
        const topExpenseList = document.getElementById('top-expense-list');
        const balanceChartCanvas = document.getElementById('balanceChart');


        // Global storage for ALL categories
        let allCategories = []; 
        let userRole = null;
        let dailyBalanceChart = null; // Chart instance

        // --- Utility Functions ---

        function showMessage(type, content) {
            messageBox.textContent = content;
            messageBox.className = 'p-3 rounded-lg text-sm transition duration-300'; // Reset classes
            messageBox.style.display = 'block';

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        function clearMessage() {
            messageBox.style.display = 'none';
        }

        function showForm(formId) {
            clearMessage();
            if (formId === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                tabs.login.classList.add('border-emerald-600', 'text-emerald-600');
                tabs.register.classList.remove('border-emerald-600', 'text-emerald-600');
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                tabs.register.classList.add('border-emerald-600', 'text-emerald-600');
                tabs.login.classList.remove('border-emerald-600', 'text-emerald-600');
            }
        }
        
        // --- Category Management UI ---

        function showCategoryModal() {
            categoryModal.classList.remove('hidden');
        }

        function hideCategoryModal() {
            categoryModal.classList.add('hidden');
            newCategoryForm.reset();
        }
        
        // Function to populate the select dropdown with ALL categories
        function populateCategories() {
            categorySelect.innerHTML = ''; // Clear existing options

            // Default placeholder option
            const allOption = document.createElement('option');
            allOption.textContent = `--- Select Category ---`;
            allOption.value = '';
            allOption.disabled = true;
            allOption.selected = true;
            categorySelect.appendChild(allOption);
            
            if (allCategories.length === 0) {
                const option = document.createElement('option');
                option.textContent = `No categories. Create one!`;
                option.value = '';
                option.disabled = true;
                categorySelect.appendChild(option);
            } else {
                allCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
            }
        }
        
        // --- State Management ---

        async function showAppState(isLoggedIn, username, role) {
            if (isLoggedIn) {
                // Set global role
                userRole = role;
                
                // Switch view from Auth to App
                authContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                
                const roleDisplay = role ? `<span class="font-bold text-emerald-700">(${role.toUpperCase()})</span>` : '';
                welcomeMessage.innerHTML = `Welcome back, <span class="font-bold">${username}</span>. Your role: ${roleDisplay}.`;
                
                // Disable income selection for standard users in the transaction form
                if (role !== 'admin') {
                    incomeTypeRadio.disabled = true;
                    document.querySelector('label[for="type-income"]').classList.add('opacity-50', 'cursor-not-allowed');
                    document.getElementById('type-expense').checked = true;
                    summaryButton.classList.add('hidden'); // Hide summary button from standard user
                    downloadButton.classList.add('hidden'); // <-- ADDED: Hide download button from standard user
                    dateRangeInputs.classList.add('hidden'); // Hide date range inputs
                } else {
                    incomeTypeRadio.disabled = false;
                    document.querySelector('label[for="type-income"]').classList.remove('opacity-50', 'cursor-not-allowed');
                    summaryButton.classList.remove('hidden'); // Show summary button for admin
                    downloadButton.classList.remove('hidden'); // <-- ADDED: Show download button for admin
                    dateRangeInputs.classList.remove('hidden'); // Show date range inputs
                }
                
                // Fetch and populate all categories
                await fetchCategories();

            } else {
                // Switch view from App to Auth
                appContent.classList.add('hidden');
                authContainer.classList.remove('hidden');

                // Reset state
                userRole = null;
                allCategories = []; 
                
                showForm('login'); // Default to login form
                
                tabs.login.classList.add('border-emerald-600', 'text-emerald-600');
            }
        }

        // Initialize state on load
        document.addEventListener('DOMContentLoaded', () => {
            const initialUser = document.body.getAttribute('data-logged-in-user');
            const initialRole = document.body.getAttribute('data-logged-in-role');
            
            if (initialUser) {
                showAppState(true, initialUser, initialRole);
            } else {
                showForm('login'); 
                tabs.login.classList.add('border-emerald-600', 'text-emerald-600');
            }
        });

        // --- API Handlers (Authentication, Category, Transaction) ---

        async function fetchCategories() {
            clearMessage();
            try {
                // Using relative path, Flask will handle the endpoint
                const response = await fetch('categories'); 
                
                if (response.ok) {
                    allCategories = await response.json(); // Store all categories
                    populateCategories(); // Populate dropdown with all categories
                    
                } else {
                    showMessage('error', 'Failed to load categories.');
                }
            } catch (error) {
                console.error('Fetch categories error:', error);
                showMessage('error', 'Network error while fetching categories.');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            clearMessage();

            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch('login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('success', data.message);
                    document.getElementById('login-form').reset();
                    // Pass the role back to showAppState
                    showAppState(true, username, data.role); 
                } else {
                    showMessage('error', data.message || 'Login failed.');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('error', 'Network error. Could not connect to the server.');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            clearMessage();

            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const secret_key = document.getElementById('reg-secret').value;

            if (!username || !password || !secret_key) {
                return showMessage('error', 'Please fill in all fields.');
            }

            try {
                const response = await fetch('register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, secret_key })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('success', data.message + ' You can now log in.');
                    document.getElementById('register-form').reset();
                    showForm('login'); // Switch to login form
                } else {
                    showMessage('error', data.message || 'Registration failed.');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showMessage('error', 'Network error. Could not connect to the server.');
            }
        }
        
        async function handleNewCategory(event) {
            event.preventDefault();
            
            const name = document.getElementById('new-cat-name').value.trim();
            
            if (!name) {
                return showMessage('error', 'Category name cannot be empty.');
            }
            
            try {
                // Only sending name
                const response = await fetch('categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name }) 
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('success', data.message);
                    
                    // Add new category to local state
                    allCategories.push({ id: data.id, name: data.name });
                    
                    populateCategories(); // Update dropdown
                    categorySelect.value = data.id; // Select the newly created category
                    
                    hideCategoryModal();
                } else {
                    showMessage('error', data.message || 'Failed to create category.');
                }
            } catch (error) {
                console.error('New category error:', error);
                showMessage('error', 'Network error during category creation.');
            }
        }

        async function handleTransaction(event) {
            event.preventDefault();
            clearMessage();
            
            const amount = document.getElementById('trans-amount').value;
            const type = document.querySelector('input[name="trans-type"]:checked').value;
            const category_id = categorySelect.value;
            const note = document.getElementById('trans-note').value.trim();
            
            if (!amount || !category_id) {
                return showMessage('error', 'Please enter an amount and select a category.');
            }
            
            try {
                const response = await fetch('transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amount,
                        type: type,
                        category_id: category_id,
                        note: note
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('success', data.message + ` (ID: ${data.id})`);
                    transactionForm.reset();
                    populateCategories(); 
                } else {
                    showMessage('error', data.message || 'Failed to record transaction. Check permissions if recording Income.');
                }
            } catch (error) {
                console.error('Transaction error:', error);
                showMessage('error', 'Network error during transaction recording.');
            }
        }
        
        // NEW: Summary Handler
        async function handleSummary() {
            clearMessage();
            
            let url = 'summary';
            const params = new URLSearchParams();
            
            const selectedCategoryId = categorySelect.value;
            const selectedCategoryName = categorySelect.options[categorySelect.selectedIndex].text;
            
            // 1. Add Category Filter
            if (selectedCategoryId && selectedCategoryName !== '--- Select Category ---') {
                params.append('category_id', selectedCategoryId);
            }
            
            // 2. Add Date Filters
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (startDate) {
                params.append('start_date', startDate);
            }
            if (endDate) {
                params.append('end_date', endDate);
            }
            
            const queryString = params.toString();
            if (queryString) {
                url += `?${queryString}`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    // --- 1. Update Header ---
                    const dateDisplay = (startDate || endDate) 
                        ? `${startDate || 'Start'} to ${endDate || 'End'}`
                        : 'All Time';
                        
                    summaryCategoryDisplay.textContent = `For Category: ${data.category_name}`;
                    summaryDateDisplay.textContent = `Date Range: ${dateDisplay}`;

                    // --- 2. Update Balance ---
                    let balance = parseFloat(data.balance).toFixed(2);
                    summaryBalanceDisplay.textContent = `₹${balance}`;
                    
                    // Color-code the balance
                    summaryBalanceDisplay.classList.remove('text-red-600', 'text-emerald-600', 'text-gray-900');
                    if (parseFloat(data.balance) < 0) {
                        summaryBalanceDisplay.classList.add('text-red-600');
                    } else if (parseFloat(data.balance) > 0) {
                        summaryBalanceDisplay.classList.add('text-emerald-600');
                    } else {
                         summaryBalanceDisplay.classList.add('text-gray-900');
                    }
                    
                    // --- 3. Draw Chart ---
                    drawDailyChart(data.daily_summary);
                    
                    // --- 4. Update Top Categories ---
                    populateCategoryList(topIncomeList, data.top_income_categories, 'income');
                    populateCategoryList(topExpenseList, data.top_expense_categories, 'expense');

                    // Show Modal
                    summaryModal.classList.remove('hidden');

                } else {
                    showMessage('error', data.message || 'Failed to calculate summary.');
                }
            } catch (error) {
                console.error('Summary error:', error);
                showMessage('error', 'Network error during summary calculation.');
            }
        }

        // --- CSV Download Logic ---

        async function downloadCSV() {
            clearMessage(); // Clear any previous messages
            
            let url = 'transactions_csv';
            const params = new URLSearchParams();
            
            // Get category and date filters from form inputs
            const selectedCategoryId = categorySelect.value;
            const selectedCategoryName = categorySelect.options[categorySelect.selectedIndex].text;

            if (selectedCategoryId && selectedCategoryName !== '--- Select Category ---') {
                params.append('category_id', selectedCategoryId);
            }
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (startDate) {
                params.append('start_date', startDate);
            }
            if (endDate) {
                params.append('end_date', endDate);
            }
            
            const queryString = params.toString();
            if (queryString) {
                url += `?${queryString}`;
            }
            
            // Use window.location.href to trigger the browser to download the file 
            // sent by the server endpoint (Flask route /transactions_csv).
            window.location.href = url;
            
            // Show a success message (or at least an attempt message)
            showMessage('info', 'CSV download initiated. Check your downloads folder.');
        }

        // Helper function to draw the Chart.js line plot
        function drawDailyChart(summaryData) {
            // Destroy existing chart if it exists
            if (dailyBalanceChart) {
                dailyBalanceChart.destroy();
            }

            const dates = summaryData.map(d => d.date);
            const incomes = summaryData.map(d => d.total_income);
            const expenses = summaryData.map(d => d.total_expense);

            const ctx = balanceChartCanvas.getContext('2d');
            dailyBalanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Income',
                        data: incomes,
                        borderColor: '#059669', // Emerald 600
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.3,
                        fill: false
                    }, {
                        label: 'Expense',
                        data: expenses,
                        borderColor: '#ef4444', // Red 500
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        // Format as Indian Rupee (₹)
                                        label += `₹${context.parsed.y.toFixed(2)}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Helper function to populate the Top Categories lists
        function populateCategoryList(ulElement, categories, type) {
            ulElement.innerHTML = '';
            
            if (categories.length === 0) {
                const message = type === 'income' 
                    ? 'No income transactions found in this range.'
                    : 'No expense transactions found in this range.';
                ulElement.innerHTML = `<li class="text-gray-500 italic">${message}</li>`;
                return;
            }

            categories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-1 border-b border-opacity-50 last:border-b-0';
                
                const amountClass = type === 'income' ? 'text-emerald-700' : 'text-red-700';

                li.innerHTML = `
                    <span class="font-medium text-gray-800">${cat.name}</span>
                    <span class="font-mono ${amountClass} font-semibold">₹${cat.total_amount.toFixed(2)}</span>
                `;
                ulElement.appendChild(li);
            });
        }


        async function handleLogout() {
            try {
                const response = await fetch('logout', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('info', data.message);
                    showAppState(false, null, null);
                } else {
                    showMessage('error', data.message || 'Logout failed.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('error', 'Network error during logout.');
            }
        }

    </script>
</body>
</html>
